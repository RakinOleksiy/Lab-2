name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test:
    name: –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è —Ç–∞ –ª—ñ–Ω—Ç–∏–Ω–≥
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']
    
    steps:
    - name: –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ–¥—É
      uses: actions/checkout@v4
    
    - name: –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: –õ—ñ–Ω—Ç–∏–Ω–≥ –∑ flake8
      run: |
        flake8 app.py --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 app.py --count --max-complexity=10 --max-line-length=120 --statistics
    
    - name: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è –∑ Black
      run: |
        black --check app.py test_app.py
    
    - name: –ê–Ω–∞–ª—ñ–∑ –∫–æ–¥—É –∑ Pylint
      run: |
        pylint app.py --disable=C0103,C0114,C0115,C0116 || true
    
    - name: –ó–∞–ø—É—Å–∫ unit —Ç–µ—Å—Ç—ñ–≤
      run: |
        pytest test_app.py -v --cov=app --cov-report=xml --cov-report=html
    
    - name: –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–≤—ñ—Ç—É –ø–æ–∫—Ä–∏—Ç—Ç—è
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report-${{ matrix.python-version }}
        path: htmlcov/
        retention-days: 7
    
    - name: –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –ø–æ–∫—Ä–∏—Ç—Ç—è –¥–æ Codecov
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage.xml
        flags: unittests
        name: codecov-${{ matrix.python-version }}

  build:
    name: –ó–±—ñ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑—É
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ–¥—É
      uses: actions/checkout@v4
    
    - name: –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: –ü–æ–±—É–¥–æ–≤–∞ Docker –æ–±—Ä–∞–∑—É
      run: |
        docker build -t task-manager:${{ github.sha }} .
        docker tag task-manager:${{ github.sha }} task-manager:latest
    
    - name: –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è Docker –æ–±—Ä–∞–∑—É
      run: |
        docker save task-manager:latest | gzip > task-manager.tar.gz
    
    - name: –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—É
      uses: actions/upload-artifact@v3
      with:
        name: docker-image
        path: task-manager.tar.gz
        retention-days: 7

  security-scan:
    name: –°–∫–∞–Ω—É–≤–∞–Ω–Ω—è –±–µ–∑–ø–µ–∫–∏
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ–¥—É
      uses: actions/checkout@v4
    
    - name: –ó–∞–ø—É—Å–∫ Trivy –¥–ª—è —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è –≤—Ä–∞–∑–ª–∏–≤–æ—Å—Ç–µ–π
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
    
    - name: –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ –¥–æ GitHub Security
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'

  deploy:
    name: –†–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ–¥—É
      uses: actions/checkout@v4
    
    - name: –°–∏–º—É–ª—è—Ü—ñ—è —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è
      run: |
        echo "üöÄ –†–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è –¥–æ–¥–∞—Ç–∫—É..."
        echo "üì¶ –í–µ—Ä—Å—ñ—è: ${{ github.sha }}"
        echo "‚úÖ –î–æ–¥–∞—Ç–æ–∫ —É—Å–ø—ñ—à–Ω–æ —Ä–æ–∑–≥–æ—Ä–Ω—É—Ç–æ!"
